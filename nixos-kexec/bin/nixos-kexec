#!/bin/sh

set -e

system=/nix/var/nix/profiles/system

append=

while [ $# -gt 0 ]; do
  case "$1" in
    --system)
      system=$2
      shift 2;;
    --append)
      append=$2
      shift 2;;
    *)
      shift;;
    # --initrd)
    #   initrd=$2
    #   shift 2;;
    # --kernel)
    #   kernel=$2
    #   shift 2;;
  esac
done

set -x

kernel=$system/kernel
initrd=$system/initrd
init=$(realpath "${system}"/init)
cmdline="init=${init} $(<$system/kernel-params)"${append:+" ${append}"}

kexec -l --initrd="${initrd}" --command-line="${cmdline}" "${kernel}"

systemctl kexec
